#!/bin/sh
#
#                          ,---.,--.               ,--.            ,--.            ,--.                      
# ,--.   ,--.,-----.      /  .-'|  | ,--,--. ,---. |  ,---.        |  ,---.  ,---. |  | ,---.  ,---. ,--.--. 
# |  |.'.|  |`-.  /       |  `-,|  |' ,-.  |(  .-' |  .-.  |,-----.|  .-.  || .-. :|  || .-. || .-. :|  .--' 
# |   .'.   | /  `-.,----.|  .-'|  |\ '-'  |.-'  `)|  | |  |'-----'|  | |  |\   --.|  || '-' '\   --.|  |    
# '--'   '--'`-----''----'`--'  `--' `--`--'`----' `--' `--'       `--' `--' `----'`--'|  |-'  `----'`--'    
#                                                                                     `--'                  
#

exec > /tmp/initramfs.log 2>&1
set -x

mount -t devtmpfs devtmpfs /dev
mount -t proc proc /proc
mount -t sysfs sysfs /sys

sleep 1

function msg() {
# Description: Allow output messages to be both displayed on the serial terminal and written to the log file
	message="$1"
	echo "$message"
	echo "$message" > /dev/console
	echo "$message" >> /tmp/initramfs_serial.log
}

function msg_dry_run() {
# Description: Print out commands when dry run is enabled
	cmd="$1"
	echo " + (this command is not run) $cmd"
	echo " + (this command is not run) $cmd" > /dev/console
	echo " + (this command is not run) $cmd" >> /tmp/initramfs_serial.log
}

function msg_nonewline() {
# Description: same as msg but without newline
	message="$1"
	echo -n "$message"
	echo -n "$message" > /dev/console
	echo -n "$message" >> /tmp/initramfs_serial.log
}

function initialize_gpio() {
# Description: Initialize GPIO for LEDs and SD card on T20 cameras
	source /init_functions_gpio.sh
	[[ "chip_family" == "t20" ]] && initialize_t20_gpio_sdcard
	initialize_gpio_leds
}

function welcome_msg() {
	msg "Welcome to $flash_tool_name!"
}

function mount_sdcard() {
	msg "Mounting SD card"
	mkdir -p /sdcard
	mount -t vfat /dev/mmcblk0p1 /sdcard -o rw,umask=0000,dmask=0000
	sleep 1
}

function import_files_and_variables() {

	flash_tool_name="wz_flash-helper"

	config_file="/sdcard/wz_flash-helper/wz_flash-helper.conf"
	log_file="/sdcard/wz_flash-helper/wz_flash-helper.log"
	log_file_serial="/sdcard/wz_flash-helper/wz_flash-helper_serial.log"
	log_file_fallback="/sdcard/wz_flash-helper_no-config-error.log"

	boot_partmtd="/dev/mtd0"
	boot_part_backup="/boot_backup"
	concat_partmtd="/dev/mtd21"
	
	source /init_functions_backup.sh
	source /init_functions_restore.sh
	source /init_functions_switch_fw.sh
	source /init_functions_misc.sh

	source /init_function_detect_chip_and_fw.sh
	source /init_function_wait_init_interrupt.sh
	source /init_function_execute_custom_script.sh
	source /init_function_exit_init.sh
	
	source /init_fw_info_t20_stock.sh
	source /init_fw_info_t31_stock.sh
	source /init_fw_info_openipc.sh

	source /init_variables_valid_openipc_boot_hashes.sh
	source /init_msg_main.sh

	[ ! -f $config_file ] && { msg "$config_file file is missing" ; mv /tmp/initramfs.log /tmp/initramfs_missing-config-file.log ; exit_init ; }
	dos2unix $config_file # Fix import config file issue with MS-DOS newline
	source $config_file || { msg "$config_file file is invalid" ; exit_init ; }
}

function main() {
	initialize_gpio
	welcome_msg
	
	wait_init_interrupt
	
	mount_sdcard
	import_files_and_variables
	
	detect_chip_and_fw

	msg
	[[ "$dry_run" == "yes" ]] && msg "$dry_run_yes" || msg "$dry_run_no"
	msg
	[[ "$backup_partitions" == "yes" ]] && { msg "$backup_partitions_yes" ; do_backup_operation ; } || msg "$backup_partitions_no"
	msg
	[[ "$restore_partitions" == "yes" ]] && { msg "$restore_partitions_yes" ; do_restore_operation ; } || msg "$restore_partitions_no"
	msg
	[[ "$switch_fw" == "yes" ]]; { msg "$switch_fw_yes" ; do_switch_fw_operation ; } || msg "$switch_fw_no"
	msg
	[[ "$enable_custom_script" == "yes" ]] && { msg "$enable_custom_script_yes" ; execute_custom_script ; } || msg "$enable_custom_script_no"
	msg
	exit_init
}


main
